<%- deposit_headers = ["ENO", "NAME", "SYNONYMS", "STATE", "OPSTATUS", "LONGITUDE", "LATITUDE", "COMMODIDS"] -%>
<%- resource_headers = ["RECORDDATE","MATERIAL","RESERVES_ORE","RESERVES_MINERAL","RESERVES_GRADE","EDR_ORE","EDR_MINERAL","EDR_GRADE","PMR_ORE","PMR_MINERAL","PMR_GRADE","SBM_ORE","SBM_MINERAL","SBM_GRADE","IFR_ORE","IFR_MINERAL","IFR_GRADE"]-%>
<%- units_headers = ["COMMODID","ORE_UNITS","MINERAL_UNITS","GRADE_UNITS"]-%>
<%# TOTAL HEADERS - INCLUDE LATER ["TOTAL_ORE","TOTAL_MINERAL","TOTAL_GRADE"] %>
<%- if @commodity.in?(['Cbl', 'Cbr'])-%>
  <%- r_units_headers = units_headers.map{|uh| "RECOVERABLE_#{uh}"}-%>
  <%- recoverable_headers = resource_headers.map{|rh| "RECOVERABLE_#{rh}"}-%>
  <%- i_units_headers = units_headers.map{|uh| "INSITU_#{uh}"}-%>
  <%- insitu_headers = resource_headers.map{|rh| "INSITU_#{rh}"}-%>
  <%- resource_headers = r_units_headers + recoverable_headers + i_units_headers+ insitu_headers -%>
<%- else -%>
  <%- resource_headers =  units_headers + resource_headers-%>
<%- end -%>
<%- headers = deposit_headers + resource_headers-%>
<%= raw CSV.generate_line headers, :row_sep => "\r" -%>
<%- @deposits.each do |deposit| -%>   
  <%- if @commodity.in?(['Cbl', 'Cbr'])-%>
    <%- recoverable = deposit.resources.merge(Resource.mineral(@commodity).recoverable.nonzero.year(@date)).all -%>
    <%- insitu = deposit.resources.merge(Resource.mineral(@commodity).insitu.nonzero.year(@date)).all -%>
    <%- recoverable_row = build_resource_csv(recoverable)-%>
    <%- insitu_row = build_resource_csv(insitu)-%>
    <%- resources_row = recoverable_row + insitu_row -%>
  <%- else -%>
    <%- resources = deposit.resources.merge(Resource.recent.nonzero.includes(:resource_grades)).all -%>
    <%- resources_row = build_resource_csv(resources) -%>
  <%- end -%>
  <%- deposit_row = [deposit.eno, deposit.entityid, deposit.deposit_status.try(:synonyms), deposit.deposit_status.try(:state), deposit.deposit_status.try(:operating_status), deposit.longitude, deposit.latitude, deposit.commodity_list.try(:commodids)] -%>
  <%- row =  deposit_row + resources_row -%>
  <%= raw CSV.generate_line row, :row_sep => "\r" -%>
<%- end -%>